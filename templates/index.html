<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>Spotify Search</title>
</head>
    
<body>
    <div class="content">
        <h1>Playlist Generator for Spotify</h1>

        <!-- Search Form -->
        <form action="/start" method = "POST">
            <span class="search-icon material-symbols-outlined">search</span>
            <input class="search-input" type="search" name="content" id="content" placeholder="What are you looking for?">
        </form>

        {% if error %}
        <p style="color: red;">{{ error }}</p>
        {% endif %}

        <!-- Results Section -->
        <div class="results">
            {% if artists %}
            <h2>Artists</h2>
            <div class="results-grid">
                {% for artist in artists %}
                <div class="result">
                    <div class="image-container">
                        <img src="{{ artist.image }}" alt="{{ artist.name }}" class="artist-image">
                        <span class="select-icon material-symbols-outlined" onclick="toggleIcon(this, '{{ artist.name }}', '{{ artist.id }}')">add_circle</span>
                    </div>
                    <p class="title">{{ artist.name }}</p>
                </div>
                
                {% endfor %}
            </div>
            {% endif %}
        </div>


        <!-- Popup for selected artists -->
        <div class="popup" id="popup">
            <h3>Selected Artists</h3>
            <ul id="selectedArtists"></ul>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="createPlaylistButton" onclick="createPlaylist()">Create Playlist</button>
                <div id="loadingSpinner" class="spinner hidden"></div>
            </div>
        </div>
        

        <!-- Playlist Section -->
        <div class="playlist" id="playlist">
            <div class="playlist-header">
                <h2>Your Playlist</h2>
                <button class="export-button" onclick="exportPlaylist()">Export Playlist</button>
            </div>
            <div id="playlistItems"></div>
        </div>

        <!-- Popup Notification -->
    <div id="popupNotification" class="popup-notification hidden">
        <span id="popupMessage"></span>
        <a id="popupLink" href="#" target="_blank" class="popup-link">View Playlist</a>
    </div>

    </div>

    <script>
        const selectedArtists = JSON.parse(localStorage.getItem("selectedArtists")) || [];

        // add artist to the list
        function addArtist(name, id) {
            if (!selectedArtists.find(artist => artist.id === id)) {
                selectedArtists.push({ name, id });
                localStorage.setItem("selectedArtists", JSON.stringify(selectedArtists)); // persist in localStorage
                updatePopup();
            }
        }

        // remove artist from the list
        function removeArtist(id) {
            const index = selectedArtists.findIndex(artist => artist.id === id);
            if (index !== -1) {
                selectedArtists.splice(index, 1);
                localStorage.setItem("selectedArtists", JSON.stringify(selectedArtists)); // update localStorage
                updatePopup();
            }
        }

        // Clear selected artists from localStorage on page load
        window.onload = function () {
            localStorage.removeItem("selectedArtists");
            updatePopup(); // Ensure the popup UI is updated accordingly
        };

        // Update the popup to reflect the current state
        function updatePopup() {
            const selectedArtists = JSON.parse(localStorage.getItem("selectedArtists")) || [];
            const popupList = document.getElementById("selectedArtists");
            popupList.innerHTML = "";
            selectedArtists.forEach(artist => {
                const li = document.createElement("li");
                li.innerHTML = `
                    ${artist.name}
                    <button onclick="removeArtist('${artist.id}')">Remove</button>
                `;
                popupList.appendChild(li);
            });
        }


        // create playlist
        async function createPlaylist() {
            const createButton = document.getElementById("createPlaylistButton");
            const spinner = document.getElementById("loadingSpinner");

            try {
                // Show spinner and disable the button
                spinner.classList.remove("hidden");
                createButton.disabled = true;

                if (selectedArtists.length === 0) {
                    alert("Please select at least one artist!");
                    return;
                }

                const artistIds = selectedArtists.map(artist => artist.id);
                const response = await fetch("/create_playlist", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ artist_ids: artistIds }),
                });

                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                } else {
                    displayPlaylist(data.playlist);
                }
            } catch (error) {
                console.error("Error creating playlist:", error);

                showPopupNotification("Failed to create playlist. Please try again.");
            } finally {
                // Hide spinner and enable the button
                spinner.classList.add("hidden");
                createButton.disabled = false;
            }
        }

        async function exportPlaylist() {
            try {
                const response = await fetch("/export_playlist");
                const data = await response.json();

                if (response.status == 400 && data.error == "No playlist available to export") {
                    showPopupNotification("No playlist available to export");
                }
                else if (data.error) {
                    alert(`Error: ${data.error}`);
                    if (data.error.includes("login")) {
                        window.location.href = "/login";
                    }
                } else if (data.message && data.playlist_url) {
                    showPopupNotification(data.message, data.playlist_url);
                } else {
                    alert("An unknown error occurred while exporting the playlist.");
                }
            } catch (error) {
                console.error("Error exporting playlist:", error);
                alert("Failed to export the playlist. Please try again.");
            }
        }

        function showPopupNotification(message, url = null) {
            const popup = document.getElementById("popupNotification");
            const popupMessage = document.getElementById("popupMessage");
            const popupLink = document.getElementById("popupLink");

            // Update message
            popupMessage.textContent = message;

            // Conditionally display or hide the link
            if (url) {
                popupLink.href = url;
                popupLink.style.display = "inline"; // Show the link if a URL is provided
            } else {
                popupLink.style.display = "none"; // Hide the link if no URL is provided
            }

            // Show popup
            popup.classList.remove("hidden");
            popup.classList.add("visible");

            // Hide popup after 5 seconds
            setTimeout(() => {
                popup.classList.remove("visible");
                popup.classList.add("hidden");
            }, 7000);
        }


        // display playlist on the page
        function displayPlaylist(playlist) {
            const playlistItems = document.getElementById("playlistItems");
            playlistItems.innerHTML = "";

            if (!playlist || playlist.length === 0) {
                playlistItems.innerHTML = "<p>No songs available for the selected artists.</p>";
                return;
            }

            // display each track
            playlist.forEach(track => {
                const div = document.createElement("div");
                div.classList.add("playlist-item");
                div.innerHTML = `
                    <img src="${track.image || 'https://via.placeholder.com/100'}" alt="${track.album}" class="playlist-image">
                    <div class="playlist-info">
                        <p class="playlist-title">${track.name}</p>
                        <p class="playlist-artist">${track.artist}</p>
                        <p class="playlist-album">${track.album}</p>
                    </div>
                `;
                playlistItems.appendChild(div);
            });
        }

        function toggleIcon(element, name, id) {
            if (element.textContent === 'add_circle') {
                // change icon to filled check_circle and make it green
                element.textContent = 'check_circle';
                element.style.color = '#1ed760';
                element.style.fontVariationSettings = "'FILL' 1"; // filled variant

                // add artist to the list
                addArtist(name, id);
            } else {
                // change icon back to unfilled add_circle
                element.textContent = 'add_circle';
                element.style.color = ''; // Revert to default
                element.style.fontVariationSettings = "'FILL' 0"; // outline variant

                // remove artist from the list
                removeArtist(id);
            }
        }

        






    </script>



</body>
</html>